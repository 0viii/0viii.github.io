<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini TikTok</title>
<style>
* {margin:0; padding:0; box-sizing:border-box;}
body, html {height:100%; width:100%; font-family:sans-serif; background:#000; overflow:hidden;}
#app {height:100vh; width:100vw; position:relative;}
.video-slide {position:absolute; top:0; left:0; height:100vh; width:100vw; display:flex; align-items:flex-end; justify-content:space-between; flex-direction:column; transition: transform 0.5s ease;}
video {width:100%; height:100%; object-fit:cover;}
.info {position:absolute; bottom:20px; left:20px; color:white; max-width:70%;}
.info h3, .info p {margin:5px 0;}
.sidebar {position:absolute; right:10px; bottom:60px; display:flex; flex-direction:column; align-items:center; gap:25px;}
.sidebar button {background: rgba(0,0,0,0.5); border:none; color:white; font-size:20px; padding:12px; border-radius:50%; cursor:pointer; transition: transform 0.2s;}
.sidebar button:hover {transform: scale(1.2);}
.music {position:absolute; bottom:20px; right:80px; width:40px; height:40px; border-radius:50%; border:3px solid white; animation: spin 3s linear infinite;}
.upload-btn {position:fixed; top:20px; left:50%; transform:translateX(-50%); background:white; color:black; padding:10px 20px; border:none; border-radius:10px; cursor:pointer; z-index:1000;}
@keyframes spin {from{transform:rotate(0deg);} to{transform:rotate(360deg);}}
</style>
</head>
<body>

<button class="upload-btn" onclick="document.getElementById('fileInput').click()">Subir Video</button>
<input type="file" id="fileInput" accept="video/*" style="display:none">
<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, arrayUnion, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDR6PNPfJDmQYv9uXUgedmozkngdk3bKDQ",
  authDomain: "minidavid-134d1.firebaseapp.com",
  projectId: "minidavid-134d1",
  storageBucket: "minidavid-134d1.firebasestorage.app",
  messagingSenderId: "326973939527",
  appId: "1:326973939527:web:32a464ab6f63262cc6b662"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);
const storage = getStorage(app);

const appDiv = document.getElementById('app');
let slidesArray = [];
let currentUser = null;

// Login automático
onAuthStateChanged(auth, user => { currentUser = user; });

// Subir videos
document.getElementById('fileInput').addEventListener('change', async e => {
  const file = e.target.files[0];
  if(!currentUser) return alert("Inicia sesión primero!");
  if(!file) return;

  const storageRef = ref(storage, `videos/${Date.now()}_${file.name}`);
  const uploadTask = uploadBytesResumable(storageRef, file);

  uploadTask.on('state_changed', null, console.error, async () => {
    const url = await getDownloadURL(uploadTask.snapshot.ref);
    await addDoc(collection(db, "videos"), {
      videoURL: url,
      username: currentUser.displayName,
      userId: currentUser.uid,
      description: "Nuevo video",
      likes: [],
      createdAt: serverTimestamp()
    });
    alert("Video subido!");
  });
});

// Botón Login
const loginBtn = document.createElement('button');
loginBtn.textContent = "Login con Google";
loginBtn.style.position = "fixed";
loginBtn.style.top = "20px";
loginBtn.style.right = "20px";
loginBtn.style.zIndex = "1000";
loginBtn.onclick = async () => {
  await signInWithPopup(auth, provider);
  alert("Login exitoso!");
};
document.body.appendChild(loginBtn);

// Cargar videos en tiempo real
async function loadVideos() {
  const videosCol = collection(db, "videos");
  onSnapshot(videosCol, snapshot => {
    appDiv.innerHTML = '';
    slidesArray = [];
    snapshot.docs.sort((a,b)=>b.data().createdAt?.seconds - a.data().createdAt?.seconds).forEach(docSnap => {
      const data = docSnap.data();
      const slide = document.createElement('div');
      slide.className = 'video-slide';
      slide.innerHTML = `
        <video src="${data.videoURL}" muted autoplay loop></video>
        <div class="info">
          <h3>@${data.username}</h3>
          <p>${data.description}</p>
        </div>
        <div class="sidebar">
          <button onclick="like('${docSnap.id}', this)">❤️ ${data.likes?.length || 0}</button>
          <button onclick="comment('${docSnap.id}')">💬</button>
          <button onclick="share('${docSnap.id}')">🔗</button>
        </div>
        <div class="music"></div>
      `;
      appDiv.appendChild(slide);
      slidesArray.push(slide);
    });
    showSlide(0);
  });
}

let index = 0;
function showSlide(i) {
  slidesArray.forEach((slide, sIndex) => {
    slide.style.transform = `translateY(${(sIndex-i)*100}%)`;
    const video = slide.querySelector('video');
    if(sIndex === i) video.play();
    else video.pause();
  });
}

window.addEventListener('wheel', e => {
  if(e.deltaY>0) index=Math.min(index+1,slidesArray.length-1);
  else index=Math.max(index-1,0);
  showSlide(index);
});

// Interacciones
window.like = async function(videoId, btn){
  if(!currentUser) return alert("Inicia sesión primero!");
  const videoRef = doc(db,"videos",videoId);
  await updateDoc(videoRef,{likes: arrayUnion(currentUser.uid)});
  const likesCount = parseInt(btn.textContent.split(' ')[1]||0)+1;
  btn.textContent = `❤️ ${likesCount}`;
};

window.comment = async function(videoId){
  if(!currentUser) return alert("Inicia sesión primero!");
  const c = prompt("Escribe tu comentario:");
  if(c) await addDoc(collection(db,"comments"),{
    videoId,
    userId: currentUser.uid,
    comment: c,
    createdAt: serverTimestamp()
  });
};

window.share = function(videoId){
  navigator.clipboard.writeText(window.location.href+"#video="+videoId);
  alert("Enlace copiado!");
};

loadVideos();
</script>
</body>
</html>
